# Figma API 429 Rate Limit Exceeded 원인 분석

## 1. Rate Limit이란?

Rate Limit은 API 서버가 **일정 시간 내에 허용하는 요청 횟수**를 제한하는 것입니다. 이는 서버 과부하를 방지하고 모든 사용자에게 공정한 서비스를 제공하기 위한 보호 장치입니다.

---

## 2. Figma API Rate Limit의 주요 원인

### 2.1 플랜별 요청 한도 제한

Figma API는 **사용자의 플랜(Plan)에 따라 다른 요청 한도**를 적용합니다:

| 플랜 | 요청 한도 |
|------|----------|
| **Starter** | 월 최대 **6회** |
| **Professional** | 더 높은 한도 (정확한 수치는 플랜에 따라 다름) |
| **Organization** | 가장 높은 한도 |

**문제 상황**:
- Starter 플랜 사용자가 한 달에 6번 이상 API를 호출하면 429 에러 발생
- 여러 사용자가 같은 토큰을 공유하는 경우 한도가 빠르게 소진됨

### 2.2 파일 위치에 따른 제한

**파일이 Starter 플랜에 속해 있으면**, 해당 파일에 대한 요청은 더 낮은 한도가 적용됩니다.

예시:
- Professional 플랜 사용자라도
- Starter 플랜에 있는 파일에 접근하면
- Starter 플랜의 제한이 적용됨

### 2.3 시간당 요청 빈도 제한

짧은 시간 내에 **너무 많은 요청을 보내면** 제한에 도달할 수 있습니다.

예시:
- 1분에 10번 이상 요청
- 같은 파일에 반복적으로 요청
- 여러 사용자가 동시에 같은 토큰 사용

### 2.4 토큰 공유로 인한 한도 소진

**같은 Personal Access Token을 여러 사용자가 공유**하는 경우:

```
사용자 A: API 호출 3회
사용자 B: API 호출 3회
→ 총 6회 (Starter 플랜 한도 소진)
→ 사용자 C가 호출하면 429 에러
```

---

## 3. 현재 구현에서 발생 가능한 원인

### 3.1 재시도 로직으로 인한 추가 요청

현재 구현된 재시도 로직:

```typescript
// Rate limit 에러인 경우 재시도
if (response.status === 429 && retryCount < maxRetries) {
  retryCount++;
  // 재시도 전 대기
  await new Promise(resolve => setTimeout(resolve, delay));
  continue; // 다시 API 호출
}
```

**문제점**:
- 429 에러 발생 시 자동으로 재시도 (최대 2회)
- 이미 한도 초과 상태인데 재시도하면 **추가 요청이 발생**
- 한도가 더 빨리 소진될 수 있음

### 3.2 사용자 행동 패턴

**발생 가능한 시나리오**:

1. **반복적인 테스트**
   - 개발 중 여러 번 "가져오기" 버튼 클릭
   - 각 클릭마다 API 호출
   - 짧은 시간 내에 한도 소진

2. **여러 파일 동시 요청**
   - 여러 Figma 파일을 빠르게 연속으로 가져오기
   - 각 요청이 한도에 카운트됨

3. **페이지 새로고침**
   - 페이지를 새로고침할 때마다 토큰이 로드됨
   - 실수로 "가져오기" 버튼을 여러 번 클릭

---

## 4. 해결 방법

### 4.1 즉시 해결 방법

#### 방법 1: Figma Plugin 사용 (권장)
- API 한도에 영향 없음
- Figma Plugin으로 JSON 직접 복사
- 무제한 사용 가능

#### 방법 2: 대기 후 재시도
- 429 에러 발생 시 **수동으로 몇 분 후 재시도**
- 자동 재시도는 한도를 더 소진시킬 수 있음

### 4.2 근본적 해결 방법

#### 방법 1: 플랜 업그레이드
- Professional 또는 Organization 플랜으로 업그레이드
- 더 높은 요청 한도 제공

#### 방법 2: 파일 위치 변경
- Starter 플랜에 있는 파일을 상위 플랜으로 이동
- 더 높은 한도 적용

#### 방법 3: 토큰 분리
- 각 사용자가 개별 토큰 사용
- 한도 공유 방지

#### 방법 4: 요청 빈도 제한
- 클라이언트 측에서 요청 간 지연 시간 추가
- 같은 파일에 대한 중복 요청 방지 (캐싱)

---

## 5. 현재 구현의 개선 사항

### 5.1 재시도 로직 개선

**현재 문제**:
- 429 에러 발생 시 자동 재시도
- 이미 한도 초과 상태인데 추가 요청 발생

**개선 방안**:
- 429 에러 발생 시 **재시도하지 않고 즉시 에러 반환**
- 사용자에게 명확한 안내 메시지 제공
- 대안 방법(Plugin 사용) 안내

### 5.2 요청 캐싱

**개선 방안**:
- 같은 파일 키에 대한 요청 결과를 일정 시간 캐싱
- 중복 요청 방지
- 한도 절약

### 5.3 사용자 안내 강화

**개선 방안**:
- Rate limit 에러 발생 시 더 자세한 안내
- 플랜별 한도 정보 제공
- 대안 방법 명확히 안내

---

## 6. 권장 사항

### 단기 해결책
1. **Figma Plugin 사용** (가장 확실한 방법)
2. 429 에러 발생 시 **수동으로 대기 후 재시도**
3. **요청 빈도 줄이기** (테스트 시 주의)

### 장기 해결책
1. **플랜 업그레이드** (팀 사용 시)
2. **요청 캐싱 구현**
3. **토큰 분리** (여러 사용자 사용 시)

---

## 7. 참고 자료

- [Figma API Rate Limit 공식 문서](https://help.figma.com/hc/en-us/articles/34963238552855-What-if-I-m-rate-limited?)
- Figma API는 플랜과 사용 패턴에 따라 제한이 다르게 적용됩니다.


