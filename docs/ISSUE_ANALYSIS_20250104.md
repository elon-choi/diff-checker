# 문제 분석: Diff 결과에 메타데이터 및 설명 텍스트 포함

## 문제 상황
- **발생 시점**: 2025-01-04
- **재현 방법**: 위키 문서와 Figma JSON을 비교
- **현상**: 총 14,778건의 차이 발견, 대부분이 메타데이터 및 설명 텍스트
- **에러 메시지/결과**: 
  - CRITICAL: 75건
  - MAJOR: 14,687건 (대부분 메타데이터/설명 텍스트)
  - MINOR: 16건

## 원인 분석

### 근본 원인
1. **메타데이터 필터링 불완전**
   - 색상 코드 (`#F4F5F7`) 필터링 누락
   - Boolean 값 (`true`, `false`, `none`) 필터링 누락
   - Figma 내부 레이블 (`Document`, `title`, `screen`) 필터링 누락

2. **설명 텍스트 필터링 부재**
   - 긴 설명 문장(50자 이상)이 비교 대상에 포함됨
   - UI 키워드가 없는 설명 텍스트도 비교 대상에 포함됨

3. **SpecNormalizer의 과도한 추출**
   - 모든 텍스트를 비교 대상으로 포함
   - UI 관련 키워드가 없는 긴 문장도 포함

### 영향 범위
- **직접 영향**: Diff 결과의 정확도 저하
- **간접 영향**: 
  - False Positive 증가로 실제 차이 파악 어려움
  - 사용자 신뢰도 하락
  - 결과 해석 시간 증가

### 관련 코드
- `apps/diff-checker/app/api/diff/route.ts`: `deriveSpecItemsFromMarkdown()`
- `packages/core-engine/src/rules.ts`: `reverseComparisonRule`

## 해결 방안

### 선택한 방안: 다층 필터링 강화

#### 방안 1: 메타데이터 필터링 강화 (선택)
- **장점**: 즉시 적용 가능, False Positive 대폭 감소
- **단점**: 패턴 추가 필요, 유지보수 필요
- **수정 내용**:
  - 색상 코드 패턴 추가: `/#([0-9A-Fa-f]{6}|[0-9A-Fa-f]{3})$/i`
  - Boolean/null 값 패턴 추가: `/(true|false|none|null|undefined)$/i`
  - Figma 내부 레이블 패턴 추가

#### 방안 2: 설명 텍스트 필터링 (선택)
- **장점**: 긴 설명 문장 제외로 정확도 향상
- **단점**: UI 키워드가 있는 긴 문장도 제외될 수 있음 (하지만 키워드 체크로 보완)
- **수정 내용**:
  - 50자 이상 문장은 UI 키워드가 없으면 제외
  - 20자 이하 짧은 텍스트만 비교 대상에 포함

#### 방안 3: Figma 텍스트 필터링 강화 (선택)
- **장점**: Figma 내부 레이블 제외로 정확도 향상
- **단점**: 새로운 Figma 레이블 추가 시 업데이트 필요
- **수정 내용**:
  - Figma 내부 레이블 리스트 추가
  - 색상 코드, boolean 값 제외

### 수정 파일
1. `apps/diff-checker/app/api/diff/route.ts`
   - `METADATA_PATTERNS` 배열 확장
   - `deriveSpecItemsFromMarkdown()` 함수 개선

2. `packages/core-engine/src/rules.ts`
   - `reverseComparisonRule` 함수 개선
   - Figma 텍스트 필터링 추가

### 예상 결과
- **개선 전**: 14,778건
- **개선 후 예상**: ~1,000-2,000건
- **False Positive 감소**: ~85-90%

## 사이드 이펙트 분석

### 영향받는 기능
1. **SpecNormalizer**
   - 메타데이터 필터링 강화로 일부 텍스트가 비교 대상에서 제외됨
   - **영향**: 의도된 동작 (메타데이터는 비교 대상이 아님)

2. **reverseComparisonRule**
   - Figma 내부 레이블 필터링으로 일부 차이가 보고되지 않음
   - **영향**: 의도된 동작 (내부 레이블은 비교 대상이 아님)

3. **기존 비교 결과**
   - 기존에 메타데이터로 인한 차이가 보고되었다면 더 이상 보고되지 않음
   - **영향**: 정확도 향상 (의도된 동작)

### 회귀 테스트 필요 항목
1. ✅ 구조화된 Spec (따옴표 사용) 비교 정상 동작 확인
2. ✅ 구조화되지 않은 Spec (자연어) 비교 정상 동작 확인
3. ✅ 실제 UI 텍스트 차이는 여전히 감지되는지 확인
4. ✅ 메타데이터는 제외되는지 확인
5. ✅ 설명 텍스트는 제외되는지 확인

### 성능 영향
- **예상 영향**: 없음 (필터링 로직 추가로 인한 오버헤드 미미)
- **확인 필요**: 대용량 Spec 문서 처리 시간 측정

### 롤백 계획
- Git 커밋으로 롤백 가능
- 변경사항이 독립적이므로 부분 롤백 가능

## 검증 방법

### 테스트 케이스
1. **메타데이터 필터링 테스트**
   - 입력: `"#F4F5F7"`, `"true"`, `"false"`, `"none"`
   - 예상: 비교 대상에서 제외

2. **설명 텍스트 필터링 테스트**
   - 입력: `"현업 요구사항 및 기존 백로그를 기반으로 우선순위를 산출하여 기능을 개선함"` (UI 키워드 없음)
   - 예상: 비교 대상에서 제외

3. **Figma 내부 레이블 필터링 테스트**
   - 입력: Figma JSON에 `"Document"`, `"title"`, `"screen"` 포함
   - 예상: 역방향 비교에서 제외

4. **실제 UI 텍스트 비교 테스트**
   - 입력: `"필터"`, `"정렬 선택"`, `"원기소"`
   - 예상: 정상적으로 비교됨

### 확인 사항
- [ ] 메타데이터가 비교 결과에서 제외되는지
- [ ] 설명 텍스트가 비교 결과에서 제외되는지
- [ ] 실제 UI 텍스트는 여전히 비교되는지
- [ ] 역방향 비교가 정상 작동하는지
- [ ] 성능 저하가 없는지

## 결론

**수정 진행 여부**: ✅ 승인

**이유**:
- False Positive 대폭 감소 예상
- 실제 UI 차이만 표시되어 사용성 향상
- 사이드 이펙트 없음 (의도된 동작)
- 롤백 가능

**다음 단계**:
1. 코드 수정 완료
2. 테스트 실행
3. 결과 검증
4. 필요시 추가 조정


